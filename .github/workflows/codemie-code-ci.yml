name: CodeMie Code CI

on:
  # Respond to issues created or when @codemie is mentioned in issue comments
  issues:
    types: [opened]
  issue_comment:
    types: [created]

  # Manual workflow dispatch with custom task
  workflow_dispatch:
    inputs:
      task_description:
        description: 'Task for CodeMie Code to implement'
        required: true
        type: string

jobs:
  codemie:
    # Run on:
    # - Manual workflow dispatch
    # - New issues created
    # - @codemie mentioned in issue comments (not on PRs - those go to inline-fix)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request == null &&
       contains(github.event.comment.body, '@codemie'))

    runs-on: ubuntu-latest
    environment: dev  # Use the 'dev' environment for secrets

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read  # Required for Claude to read CI results on PRs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Cache CodeMie CLI
        id: cache-codemie-cli
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: codemie-cli-${{ runner.os }}-${{ hashFiles('~/.npm/_cacache') }}
          restore-keys: |
            codemie-cli-${{ runner.os }}-

      - name: Install CodeMie CLI
        run: npm install -g @codemieai/code

      - name: Install Claude Code
        run: codemie install claude

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: '1.8.0'
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: poetry-cache-${{ runner.os }}-py3.11-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            poetry-cache-${{ runner.os }}-py3.11-

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.11-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.11-

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: |
          poetry install --no-interaction --no-root
          poetry install --no-interaction

      - name: Install dependencies (cache hit)
        if: steps.cached-poetry-dependencies.outputs.cache-hit == 'true'
        run: |
          echo "‚úÖ Using cached dependencies"
          poetry install --no-interaction --no-root
          poetry install --no-interaction

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Verify AWS Credentials
        run: |
          echo "Checking AWS credentials..."
          if [ -z "${{ secrets.AWS_REGION }}" ]; then
            echo "‚ùå ERROR: AWS_REGION secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "‚ùå ERROR: AWS_ACCESS_KEY_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "‚ùå ERROR: AWS_SECRET_ACCESS_KEY secret is not set"
            exit 1
          fi
          echo "‚úÖ All AWS secrets are configured"

          # Verify credentials work
          export AWS_REGION="${{ secrets.AWS_REGION }}"
          export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"

          # Test AWS credentials
          if command -v aws &> /dev/null; then
            echo "Testing AWS credentials..."
            aws sts get-caller-identity || echo "‚ö†Ô∏è Warning: Could not verify AWS credentials, but will proceed"
          else
            echo "AWS CLI not available for credential verification, proceeding..."
          fi

      - name: Run CodeMie AI Implementation
        id: claude
        env:
          # AWS Bedrock Configuration
          CLAUDE_CODE_USE_BEDROCK: "1"
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          # Project Configuration
          PYTHONPATH: "src"
          POETRY_VIRTUALENVS_IN_PROJECT: "true"
          # CI/CD Configuration
          CI: "true"
          GITHUB_ACTIONS: "true"
          # Claude Configuration
          MAX_TURNS: ${{ vars.CODEMIE_MAX_TURNS || '50' }}
        run: |
          # Determine the base prompt and context based on trigger type
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BASE_PROMPT="${{ github.event.inputs.task_description }}"
            ISSUE_NUMBER=""
          elif [ "${{ github.event_name }}" == "issues" ]; then
            BASE_PROMPT="Implement a fix for issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

          Issue Description:
          ${{ github.event.issue.body }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            BASE_PROMPT="Address the request in issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

          Comment from @${{ github.event.comment.user.login }}:
          ${{ github.event.comment.body }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          else
            BASE_PROMPT="Implement the requested changes"
            ISSUE_NUMBER=""
          fi

          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV

          # Add verification instructions to the prompt
          cat > /tmp/full-prompt.txt << 'PROMPT_EOF'
          ${BASE_PROMPT}

          ## CRITICAL: Verification Steps

          After implementing your changes, you MUST:

          1. **Run code quality checks**:
             ```bash
             source .venv/bin/activate && make ruff-fix
             ```

          2. **Run all tests**:
             ```bash
             source .venv/bin/activate && make test
             ```

          3. **Verify everything passes**:
             - If ruff reports errors, fix them
             - If tests fail, fix the failing tests or your implementation
             - Re-run until both pass

          4. **Only then commit your changes**

          DO NOT commit code that fails tests or ruff checks. The workflow will fail if verification doesn't pass.
          PROMPT_EOF

          # Replace the variable
          sed -i "s|\${BASE_PROMPT}|${BASE_PROMPT}|g" /tmp/full-prompt.txt

          PROMPT="$(cat /tmp/full-prompt.txt)"

          # Set model from secret or use default
          MODEL="${{ secrets.ANTHROPIC_MODEL }}"
          if [ -z "$MODEL" ]; then
            MODEL="anthropic.claude-3-5-sonnet-20241022-v2:0"
          fi

          echo "================================================"
          echo "CodeMie Code CI Configuration"
          echo "================================================"
          echo "Event: ${{ github.event_name }}"
          echo "Model: $MODEL"
          echo "AWS Region: $AWS_REGION"
          echo "AWS Access Key ID: ${AWS_ACCESS_KEY_ID:0:8}..."
          echo "Bedrock Enabled: $CLAUDE_CODE_USE_BEDROCK"
          echo "Prompt: $PROMPT"
          echo "================================================"

          # Run CodeMie AI with timeout and verbose output
          timeout 30m claude \
            -p "$(cat /tmp/full-prompt.txt)" \
            --model "$MODEL" \
            --max-turns "${MAX_TURNS}" \
            --dangerously-skip-permissions \
            --allowedTools "Bash(*),Read(*),Write(*),Edit(*),Grep(*),Glob(*)" \
            --debug \
            2>&1 | tee /tmp/claude-output.log || {
              EXIT_CODE=$?
              echo "CodeMie AI exited with code: $EXIT_CODE"
              if [ $EXIT_CODE -eq 124 ]; then
                echo "Error: CodeMie AI timed out after 30 minutes"
                exit 1
              fi
              # Show last 100 lines of output for debugging
              echo "=== Last 100 lines of CodeMie AI output ==="
              tail -n 100 /tmp/claude-output.log
              exit $EXIT_CODE
            }

          echo "=== CodeMie AI execution completed ==="

      - name: Verify Code Quality (Safety Check)
        id: verify
        run: |
          echo "================================================"
          echo "Running Safety Verification"
          echo "================================================"
          echo "This is a final safety check to ensure CodeMie AI"
          echo "properly ran tests and ruff checks."
          echo ""

          # Activate virtual environment and run verification
          source .venv/bin/activate && make verify || {
            EXIT_CODE=$?
            echo ""
            echo "‚ùå Verification failed with exit code: $EXIT_CODE"
            echo ""
            echo "‚ö†Ô∏è  WARNING: CodeMie AI should have run these checks before committing!"
            echo "    Please review the implementation to ensure the AI followed instructions."
            echo ""
            exit $EXIT_CODE
          }

          echo ""
          echo "‚úÖ All verification checks passed"
          echo "‚úÖ CodeMie AI successfully implemented and verified the changes"

      - name: Upload CodeMie Code Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codemie-code-output-${{ github.run_number }}
          path: /tmp/claude-output.log
          retention-days: 30

      - name: Commit and Push Changes
        if: success() && steps.verify.outcome == 'success'
        run: |
          echo "Checking for changes..."
          git status

          # Check if there are any changes to commit
          if git diff --quiet && git diff --cached --quiet; then
            echo "‚úÖ No changes to commit"
            exit 0
          fi

          echo "üìù Changes detected, committing..."

          # Create branch name and commit message based on trigger
          if [ -n "$ISSUE_NUMBER" ]; then
            BRANCH_NAME="codemie/issue-${ISSUE_NUMBER}"
            if [ "${{ github.event_name }}" == "issues" ]; then
              COMMIT_MSG="fix: resolve #${ISSUE_NUMBER} - ${{ github.event.issue.title }}

          Co-authored-by: CodeMie AI <codemie.ai@gmail.com>"
            else
              COMMIT_MSG="fix: address #${ISSUE_NUMBER} - ${{ github.event.issue.title }}

          Co-authored-by: CodeMie AI <codemie.ai@gmail.com>"
            fi
          else
            BRANCH_NAME="codemie/task-$(date +%Y%m%d-%H%M%S)"
            COMMIT_MSG="feat: ${{ github.event.inputs.task_description }}

          Co-authored-by: CodeMie AI <codemie.ai@gmail.com>"
          fi

          echo "Branch: $BRANCH_NAME"

          # Create and checkout branch
          git checkout -b "$BRANCH_NAME" 2>/dev/null || git checkout "$BRANCH_NAME"

          # Stage all changes
          git add -A

          # Commit changes
          git commit -m "$COMMIT_MSG"

          # Push branch
          git push -u origin "$BRANCH_NAME"

          echo "‚úÖ Changes committed and pushed to branch: $BRANCH_NAME"

      - name: Create Pull Request
        if: success() && steps.verify.outcome == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if we have a branch to create PR from
          CURRENT_BRANCH=$(git branch --show-current)

          if [ "$CURRENT_BRANCH" == "main" ] || [ "$CURRENT_BRANCH" == "master" ]; then
            echo "‚ö†Ô∏è On main branch, no PR needed"
            exit 0
          fi

          echo "Creating PR from branch: $CURRENT_BRANCH"

          # Create PR title and body based on trigger
          if [ -n "$ISSUE_NUMBER" ]; then
            if [ "${{ github.event_name }}" == "issues" ]; then
              PR_TITLE="ü§ñ Fix #${ISSUE_NUMBER}: ${{ github.event.issue.title }}"
              PR_BODY="## Resolves
          Closes #${ISSUE_NUMBER}

          ## Issue Description
          ${{ github.event.issue.body }}

          ## Changes
          CodeMie AI has analyzed and implemented a fix for this issue.

          ## Verification
          ‚úÖ All tests passed
          ‚úÖ Code quality checks passed (Ruff)

          ---
          ü§ñ This PR was automatically created by CodeMie AI via GitHub Actions
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            else
              PR_TITLE="ü§ñ Address #${ISSUE_NUMBER}: ${{ github.event.issue.title }}"
              PR_BODY="## Related to
          Addresses #${ISSUE_NUMBER}

          ## Comment Context
          This PR addresses a request from @${{ github.event.comment.user.login }} in issue #${ISSUE_NUMBER}

          ## Changes
          CodeMie AI has implemented the requested changes.

          ## Verification
          ‚úÖ All tests passed
          ‚úÖ Code quality checks passed (Ruff)

          ---
          ü§ñ This PR was automatically created by CodeMie AI via GitHub Actions
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            fi
          else
            PR_TITLE="ü§ñ CodeMie AI: ${{ github.event.inputs.task_description }}"
            PR_BODY="## Task Description

          ${{ github.event.inputs.task_description }}

          ## Changes
          CodeMie AI has implemented the requested changes.

          ## Verification
          ‚úÖ All tests passed
          ‚úÖ Code quality checks passed (Ruff)

          ---
          ü§ñ This PR was automatically created by CodeMie AI via GitHub Actions
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          # Create PR using GitHub CLI and capture URL
          PR_URL=$(gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$CURRENT_BRANCH" 2>&1) || {
            echo "‚ö†Ô∏è PR might already exist or couldn't be created"
            PR_URL=$(gh pr list --head "$CURRENT_BRANCH" --json url --jq '.[0].url' 2>/dev/null || echo "")
          }

          if [ -n "$PR_URL" ]; then
            echo "‚úÖ Pull request created: $PR_URL"
            echo "PR_URL=$PR_URL" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è No PR URL available"
          fi

      - name: Comment on Issue
        if: success() && steps.verify.outcome == 'success' && env.ISSUE_NUMBER != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUM="${ISSUE_NUMBER}"

          if [ -z "$ISSUE_NUM" ]; then
            echo "No issue number found, skipping comment"
            exit 0
          fi

          echo "Commenting on issue #${ISSUE_NUM}..."

          # Create comment body
          if [ -n "$PR_URL" ]; then
            COMMENT="üëã Hi! I've analyzed this issue and created a fix.

          **Pull Request**: ${PR_URL}

          ## What I did:
          - ‚úÖ Implemented the changes
          - ‚úÖ Ran code quality checks (Ruff)
          - ‚úÖ Ran all tests

          Please review the PR. Once merged, this issue will be automatically closed.

          ---
          ü§ñ _CodeMie AI - Automated by GitHub Actions_
          [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          else
            COMMENT="üëã Hi! I've worked on this issue and made changes.

          ## What I did:
          - ‚úÖ Implemented the changes
          - ‚úÖ Ran code quality checks (Ruff)
          - ‚úÖ Ran all tests

          ---
          ü§ñ _CodeMie AI - Automated by GitHub Actions_
          [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          fi

          # Post comment using GitHub CLI
          gh issue comment "${ISSUE_NUM}" --body "$COMMENT"

          echo "‚úÖ Comment posted to issue #${ISSUE_NUM}"

      - name: Post Summary
        if: always()
        run: |
          echo "## ü§ñ CodeMie Code CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "**Trigger**: Manual (workflow_dispatch)" >> $GITHUB_STEP_SUMMARY
            echo "**Task**: ${{ github.event.inputs.task_description }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" == "issues" ]; then
            echo "**Trigger**: New Issue #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
            echo "**Issue**: ${{ github.event.issue.title }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "**Trigger**: Issue Comment (@codemie)" >> $GITHUB_STEP_SUMMARY
            echo "**Issue**: #${{ github.event.issue.number }} - ${{ github.event.issue.title }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîß Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Provider**: AWS Bedrock" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Region**: ${{ secrets.AWS_REGION && '‚úÖ Configured' || '‚ùå Not set' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Credentials**: ${{ secrets.AWS_ACCESS_KEY_ID && '‚úÖ Configured' || '‚ùå Not set' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Model**: ${{ secrets.ANTHROPIC_MODEL && secrets.ANTHROPIC_MODEL || 'anthropic.claude-3-5-sonnet-20241022-v2:0 (default)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ‚úÖ Verification" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify.outcome }}" == "success" ]; then
            echo "- **Tests**: ‚úÖ Passed" >> $GITHUB_STEP_SUMMARY
            echo "- **Code Quality (Ruff)**: ‚úÖ Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Tests**: ${{ steps.verify.outcome == 'failure' && '‚ùå Failed' || '‚è≠Ô∏è Skipped' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Code Quality (Ruff)**: ${{ steps.verify.outcome == 'failure' && '‚ùå Failed' || '‚è≠Ô∏è Skipped' }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üì¶ Outputs" >> $GITHUB_STEP_SUMMARY
          if [ -n "$PR_URL" ]; then
            echo "- **Pull Request**: [$PR_URL]($PR_URL) ‚úÖ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Pull Request**: Not created (no changes or verification failed)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **CodeMie Code Log**: Available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üìã Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the [CodeMie Code output artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed execution logs" >> $GITHUB_STEP_SUMMARY
          if [ -n "$PR_URL" ]; then
            echo "2. Review and merge the [Pull Request]($PR_URL)" >> $GITHUB_STEP_SUMMARY
          fi
