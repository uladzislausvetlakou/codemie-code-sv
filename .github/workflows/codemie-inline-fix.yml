name: 'üîß CodeMie Inline Code Fix'

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.pull_request.number }}-${{ github.event.comment.id || github.event.review.id }}
  cancel-in-progress: false  # Don't cancel - each fix request is independent

defaults:
  run:
    shell: bash

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  codemie-fix:
    # Only run if @codemie is mentioned but NOT @codemie-review or @codemie-ai-review (which trigger the review workflow)
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request != null &&
       (contains(github.event.comment.body, '@codemie') ||
        contains(github.event.comment.body, '@CodeMie') ||
        contains(github.event.comment.body, '@CODEMIE')) &&
       !(contains(github.event.comment.body, '@codemie-review') ||
         contains(github.event.comment.body, '@codemie-ai-review') ||
         contains(github.event.comment.body, '@CodeMie-review') ||
         contains(github.event.comment.body, '@CODEMIE-REVIEW'))) ||
      (github.event_name == 'pull_request_review_comment' &&
       (contains(github.event.comment.body, '@codemie') ||
        contains(github.event.comment.body, '@CodeMie') ||
        contains(github.event.comment.body, '@CODEMIE')) &&
       !(contains(github.event.comment.body, '@codemie-review') ||
         contains(github.event.comment.body, '@codemie-ai-review') ||
         contains(github.event.comment.body, '@CodeMie-review') ||
         contains(github.event.comment.body, '@CODEMIE-REVIEW'))) ||
      (github.event_name == 'pull_request_review' &&
       (contains(github.event.review.body, '@codemie') ||
        contains(github.event.review.body, '@CodeMie') ||
        contains(github.event.review.body, '@CODEMIE')) &&
       !(contains(github.event.review.body, '@codemie-review') ||
         contains(github.event.review.body, '@codemie-ai-review') ||
         contains(github.event.review.body, '@CodeMie-review') ||
         contains(github.event.review.body, '@CODEMIE-REVIEW')))

    timeout-minutes: 10
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Add "eyes" reaction to show we're working
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              let commentId;
              let reactionType;

              if (context.eventName === 'pull_request_review_comment') {
                // For PR review comments (inline), use different API
                commentId = context.payload.comment.id;
                reactionType = 'createForPullRequestReviewComment';
              } else if (context.eventName === 'issue_comment') {
                // For issue/PR conversation comments
                commentId = context.payload.comment.id;
                reactionType = 'createForIssueComment';
              } else if (context.eventName === 'pull_request_review') {
                // For review summaries - can't add reaction, skip
                console.log('Cannot add reaction to review summary, skipping');
                return;
              }

              if (commentId) {
                await github.rest.reactions[reactionType]({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: commentId,
                  content: 'eyes'
                });
                console.log('Added eyes reaction to comment', commentId);
              }
            } catch (error) {
              console.log('Failed to add reaction (non-critical):', error.message);
            }

      - name: Extract PR and branch information
        id: pr_info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let prNumber, branchName, commentBody, commentUrl, commentPath, commentLine, isReply;

            // Get PR number and comment details based on event type
            if (context.eventName === 'issue_comment' && context.payload.issue.pull_request) {
              // Comment on PR conversation (includes replies)
              prNumber = context.payload.issue.number;
              commentBody = context.payload.comment.body;
              commentUrl = context.payload.comment.html_url;

              // Check if this is a reply to another comment
              if (context.payload.comment.in_reply_to_id) {
                isReply = true;
                console.log('This is a reply to comment:', context.payload.comment.in_reply_to_id);
              }

              // Get PR details to find branch
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              branchName = pr.data.head.ref;

            } else if (context.eventName === 'pull_request_review_comment') {
              // Inline comment on PR diff (or reply to inline comment)
              prNumber = context.payload.pull_request.number;
              branchName = context.payload.pull_request.head.ref;
              commentBody = context.payload.comment.body;
              commentUrl = context.payload.comment.html_url;
              commentPath = context.payload.comment.path;
              commentLine = context.payload.comment.line || context.payload.comment.original_line;

              // Check if this is a reply
              if (context.payload.comment.in_reply_to_id) {
                isReply = true;
                console.log('This is a reply to inline comment:', context.payload.comment.in_reply_to_id);
              }

            } else if (context.eventName === 'pull_request_review') {
              // Review comment
              prNumber = context.payload.pull_request.number;
              branchName = context.payload.pull_request.head.ref;
              commentBody = context.payload.review.body;
              commentUrl = context.payload.review.html_url;
            }

            // Extract instructions after @codemie or @codemie-ai (case-insensitive)
            const instructions = commentBody.replace(/@codemie(-ai)?\s*/i, '').trim();

            core.setOutput('pr_number', prNumber);
            core.setOutput('branch_name', branchName);
            core.setOutput('comment_body', commentBody);
            core.setOutput('comment_url', commentUrl);
            core.setOutput('instructions', instructions);
            core.setOutput('comment_path', commentPath || '');
            core.setOutput('comment_line', commentLine || '');
            core.setOutput('is_reply', isReply || false);

            console.log('='.repeat(50));
            console.log('PR Number:', prNumber);
            console.log('Branch:', branchName);
            console.log('Is Reply:', isReply || false);
            console.log('Instructions:', instructions);
            console.log('File:', commentPath || 'N/A');
            console.log('Line:', commentLine || 'N/A');
            console.log('Comment URL:', commentUrl);
            console.log('='.repeat(50));

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_info.outputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install CodeMie CLI
        run: npm install -g @codemieai/code

      - name: Install Claude Code
        run: codemie install claude

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: '1.8.0'
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: poetry-cache-${{ runner.os }}-py3.11-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            poetry-cache-${{ runner.os }}-py3.11-

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.11-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.11-

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction

      - name: Configure Git
        run: |
          git config --global user.email "codemie-bot[bot]@users.noreply.github.com"
          git config --global user.name "CodeMie Bot"

      - name: Verify AWS Credentials
        run: |
          if [ -z "${{ secrets.AWS_REGION }}" ]; then
            echo "‚ùå ERROR: AWS_REGION secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "‚ùå ERROR: AWS_ACCESS_KEY_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "‚ùå ERROR: AWS_SECRET_ACCESS_KEY secret is not set"
            exit 1
          fi
          echo "‚úÖ AWS credentials configured"

      - name: Run CodeMie Inline Fix
        id: codemie_fix
        env:
          # AWS Bedrock Configuration
          CLAUDE_CODE_USE_BEDROCK: "1"
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          # Project Configuration
          PYTHONPATH: "src"
          POETRY_VIRTUALENVS_IN_PROJECT: "true"
          # CI Configuration
          CI: "true"
          GITHUB_ACTIONS: "true"
          # Claude Configuration
          MAX_TURNS: ${{ vars.CODEMIE_MAX_TURNS || '50' }}
          # Context
          PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
          BRANCH_NAME: ${{ steps.pr_info.outputs.branch_name }}
          INSTRUCTIONS: ${{ steps.pr_info.outputs.instructions }}
          COMMENT_PATH: ${{ steps.pr_info.outputs.comment_path }}
          COMMENT_LINE: ${{ steps.pr_info.outputs.comment_line }}
          COMMENT_URL: ${{ steps.pr_info.outputs.comment_url }}
        run: |
          set -euo pipefail

          # Determine model
          MODEL="${{ secrets.ANTHROPIC_MODEL }}"
          if [ -z "$MODEL" ]; then
            MODEL="anthropic.claude-3-5-sonnet-20241022-v2:0"
          fi

          echo "================================================"
          echo "CodeMie Inline Fix"
          echo "================================================"
          echo "PR: #${PR_NUMBER}"
          echo "Branch: ${BRANCH_NAME}"
          echo "Model: ${MODEL}"
          echo "Instructions: ${INSTRUCTIONS}"
          if [ -n "${COMMENT_PATH}" ]; then
            echo "File: ${COMMENT_PATH}:${COMMENT_LINE}"
          fi
          echo "Comment: ${COMMENT_URL}"
          echo "================================================"

          # Create focused prompt for quick inline fix
          cat > /tmp/fix-prompt.txt << 'PROMPT_EOF'
          ## Your Role

          You are CodeMie, a focused code assistant that makes quick, precise code changes based on comments.

          ## Your Task

          Someone has commented on code in a Pull Request asking you to make a change. Your job is to:
          1. Understand the request
          2. Make the specific change requested
          3. Commit it
          4. Keep it simple and focused

          ## Context

          - **PR Number**: ${PR_NUMBER}
          - **Branch**: ${BRANCH_NAME}
          - **Request**: ${INSTRUCTIONS}
          PROMPT_EOF

          # Add file context if this is an inline comment
          if [ -n "${COMMENT_PATH}" ]; then
            cat >> /tmp/fix-prompt.txt << PROMPT_EOF2

          - **File commented on**: ${COMMENT_PATH}
          - **Line number**: ${COMMENT_LINE}
          - **Comment location**: ${COMMENT_URL}

          ## Instructions

          1. First, read the file that was commented on:
             \`\`\`bash
             cat "${COMMENT_PATH}"
             \`\`\`

          2. Look at the specific line (around line ${COMMENT_LINE}) and understand the context

          3. Make the change requested: ${INSTRUCTIONS}

          4. The change should be focused on the commented code area
          PROMPT_EOF2
          else
            cat >> /tmp/fix-prompt.txt << 'PROMPT_EOF3'

          ## Instructions

          1. Review the PR changes to understand context:
             ```bash
             git diff origin/main...HEAD
             ```

          2. Understand what needs to be changed: ${INSTRUCTIONS}

          3. Make the requested changes
          PROMPT_EOF3
          fi

          # Add common instructions
          cat >> /tmp/fix-prompt.txt << 'PROMPT_EOF4'

          ## Guidelines

          **DO:**
          - ‚úÖ Make the exact change requested
          - ‚úÖ Keep it simple and focused
          - ‚úÖ Follow existing code style
          - ‚úÖ Test your change if possible (run relevant commands)
          - ‚úÖ Commit with a clear message

          **DON'T:**
          - ‚ùå Make unrelated changes
          - ‚ùå Refactor surrounding code
          - ‚ùå Add unnecessary features
          - ‚ùå Change code style unnecessarily
          - ‚ùå Over-engineer the solution

          ## Commit Message Format

          Use this format:
          ```
          fix: [brief description of the change]

          Requested by: ${COMMENT_URL}

          Co-authored-by: CodeMie AI <codemie.ai@gmail.com>
          ```

          ## Important

          - You're on branch: ${BRANCH_NAME}
          - Changes will be committed directly to this branch
          - Keep it quick: this is a focused inline fix, not a feature implementation
          - If you need to activate venv: `source .venv/bin/activate`
          - Follow DEV_GUIDE.md patterns if they exist

          ## Start

          Begin by understanding the request and the code context, then make the change.
          PROMPT_EOF4

          # Replace environment variables in prompt
          sed -i "s|\${PR_NUMBER}|${PR_NUMBER}|g" /tmp/fix-prompt.txt
          sed -i "s|\${BRANCH_NAME}|${BRANCH_NAME}|g" /tmp/fix-prompt.txt
          sed -i "s|\${INSTRUCTIONS}|${INSTRUCTIONS}|g" /tmp/fix-prompt.txt
          sed -i "s|\${COMMENT_PATH}|${COMMENT_PATH}|g" /tmp/fix-prompt.txt
          sed -i "s|\${COMMENT_LINE}|${COMMENT_LINE}|g" /tmp/fix-prompt.txt
          sed -i "s|\${COMMENT_URL}|${COMMENT_URL}|g" /tmp/fix-prompt.txt

          echo ""
          echo "Running CodeMie fix with max-turns: ${MAX_TURNS}..."
          echo ""

          # Run CodeMie Code with focused permissions for quick fixes
          timeout 10m claude \
            -p "$(cat /tmp/fix-prompt.txt)" \
            --model "${MODEL}" \
            --max-turns "${MAX_TURNS}" \
            --dangerously-skip-permissions \
            --allowedTools "Bash(*),Read(*),Write(*),Edit(*),Grep(*),Glob(*)" \
            --debug \
            2>&1 | tee /tmp/codemie-fix-output.log || {
              EXIT_CODE=$?
              echo "CodeMie exited with code: ${EXIT_CODE}"
              if [ ${EXIT_CODE} -eq 124 ]; then
                echo "Error: CodeMie timed out after 10 minutes"
                exit 1
              fi
              exit ${EXIT_CODE}
            }

          echo "‚úÖ CodeMie fix completed"

      - name: Upload CodeMie Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codemie-fix-output-${{ github.run_number }}
          path: /tmp/codemie-fix-output.log
          retention-days: 7

      - name: Commit any uncommitted changes
        id: commit_changes
        run: |
          # Check if there are uncommitted changes (modified or new files)
          if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
            echo "Found uncommitted changes, committing them..."

            # Stage all changes
            git add -A

            # Create commit message
            COMMIT_MSG="fix: apply CodeMie requested changes

          Requested by: ${{ steps.pr_info.outputs.comment_url }}

          Co-authored-by: CodeMie AI <codemie.ai@gmail.com>"

            # Commit changes
            git commit -m "$COMMIT_MSG" || echo "Commit may have been done by Claude already"

            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes committed"
          else
            echo "No uncommitted changes"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if there are commits to push
        id: check_push
        run: |
          # Check if local branch is ahead of remote
          git fetch origin ${{ steps.pr_info.outputs.branch_name }}

          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse origin/${{ steps.pr_info.outputs.branch_name }} 2>/dev/null || echo "")

          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "has_commits=true" >> $GITHUB_OUTPUT
            echo "Local branch is ahead of remote, push needed"

            # Show what will be pushed
            if [ -n "$REMOTE" ]; then
              echo "Commits to push:"
              git log --oneline origin/${{ steps.pr_info.outputs.branch_name }}..HEAD
            else
              echo "New branch will be pushed"
            fi
          else
            echo "has_commits=false" >> $GITHUB_OUTPUT
            echo "Local branch is up to date with remote"
          fi

      - name: Push changes to PR branch with retry
        if: steps.check_push.outputs.has_commits == 'true'
        run: |
          BRANCH="${{ steps.pr_info.outputs.branch_name }}"
          MAX_ATTEMPTS=3

          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "================================================"
            echo "Push attempt $i of $MAX_ATTEMPTS"
            echo "================================================"

            # Fetch latest changes from remote
            echo "Fetching latest changes from origin/$BRANCH..."
            git fetch origin "$BRANCH"

            # Try to push
            echo "Attempting to push to $BRANCH..."
            if git push origin HEAD 2>&1; then
              echo "‚úÖ Changes pushed successfully on attempt $i"
              exit 0
            fi

            # Push failed, check if we should retry
            if [ $i -lt $MAX_ATTEMPTS ]; then
              echo "‚ö†Ô∏è Push failed (likely non-fast-forward), attempting rebase..."

              # Try to rebase on top of remote changes
              if git rebase "origin/$BRANCH"; then
                echo "‚úÖ Rebased successfully on origin/$BRANCH"
                echo "Retrying push..."
              else
                echo "‚ùå Rebase failed due to conflicts"
                git rebase --abort
                echo ""
                echo "This usually means:"
                echo "- Multiple CodeMie workflows modified the same lines"
                echo "- Manual intervention needed to resolve conflicts"
                exit 1
              fi
            else
              echo "‚ùå Failed to push after $MAX_ATTEMPTS attempts"
              exit 1
            fi

            echo ""
          done

          echo "‚ùå Unexpected: Loop completed without success or failure"
          exit 1

      - name: Reply to comment with success
        if: success() && steps.check_push.outputs.has_commits == 'true'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr_info.outputs.pr_number }};
            const branchName = '${{ steps.pr_info.outputs.branch_name }}';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            // Get list of changed files
            const { execSync } = require('child_process');
            const changedFiles = execSync('git diff HEAD~1 --name-only').toString().trim();

            const reply = `‚úÖ **Fixed by CodeMie!**

            Changes have been committed to branch \`${branchName}\`.

            **Files modified:**
            \`\`\`
            ${changedFiles}
            \`\`\`

            **Commit**: ${context.sha.substring(0, 7)}

            [View workflow run](${runUrl}) | [View changes](https://github.com/${{ github.repository }}/pull/${prNumber}/files)

            ---
            ü§ñ *CodeMie - Your inline code assistant*`;

            try {
              // Try to post as regular PR comment (works for all cases)
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: reply
              });
              console.log('Posted success reply to PR #' + prNumber);

              // Try to add thumbs up reaction to original comment
              try {
                const commentId = context.payload.comment?.id || context.payload.review?.id;
                if (commentId) {
                  if (context.eventName === 'pull_request_review_comment') {
                    await github.rest.reactions.createForPullRequestReviewComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      comment_id: commentId,
                      content: '+1'
                    });
                  } else if (context.eventName === 'issue_comment') {
                    await github.rest.reactions.createForIssueComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      comment_id: commentId,
                      content: '+1'
                    });
                  }
                  console.log('Added thumbs up reaction');
                }
              } catch (reactionError) {
                console.log('Could not add reaction (non-critical):', reactionError.message);
              }
            } catch (error) {
              console.log('Failed to post reply:', error.message);
            }

      - name: Reply to comment with no changes
        if: success() && steps.check_push.outputs.has_commits == 'false'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr_info.outputs.pr_number }};
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            const reply = `‚ÑπÔ∏è **CodeMie completed**

            No changes were needed, or the requested change couldn't be applied.

            This might mean:
            - The change was already present in the code
            - The request wasn't clear enough
            - The change couldn't be made safely

            [View workflow run](${runUrl}) for details.

            ---
            ü§ñ *CodeMie - Your inline code assistant*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: reply
            });

      - name: Reply to comment with failure
        if: failure()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr_info.outputs.pr_number }};
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            const reply = `‚ùå **CodeMie encountered an error**

            I wasn't able to complete the requested change due to an error.

            **Common issues:**
            - AWS Bedrock credentials not configured
            - Request was too complex for quick fix
            - Code conflicts or merge issues

            [View workflow logs](${runUrl}) for details.

            **Try:**
            - Simplify the request (one specific change at a time)
            - Make sure the file/line still exists
            - Check if there are merge conflicts

            ---
            ü§ñ *CodeMie - Your inline code assistant*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: reply
            });
